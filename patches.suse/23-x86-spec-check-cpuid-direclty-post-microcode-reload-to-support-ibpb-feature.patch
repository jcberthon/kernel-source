From: Tom Lendacky <thomas.lendacky@amd.com>
Date: Mon, 18 Dec 2017 11:55:18 +0100
Subject: x86/spec: Check CPUID direclty post microcode reload to support IBPB
 feature
Patch-mainline: submitted on 2018/1/9
References: bsc#1068032

Add an IBPB feature check to the speculative control update check after
a microcode reload.

Signed-off-by: Tom Lendacky <thomas.lendacky@amd.com>
[ Check CPUID directly. ]
Signed-off-by: Borislav Petkov <bp@suse.de>
---
 arch/x86/kernel/cpu/spec_ctrl.c |   19 +++++++++----------
 1 file changed, 9 insertions(+), 10 deletions(-)

--- a/arch/x86/kernel/cpu/spec_ctrl.c
+++ b/arch/x86/kernel/cpu/spec_ctrl.c
@@ -44,20 +44,19 @@ EXPORT_SYMBOL_GPL(x86_enable_ibrs);
  */
 void x86_spec_check(void)
 {
-	if (boot_cpu_data.x86_vendor == X86_VENDOR_INTEL) {
-		if (cpuid_edx(7) & BIT(26)) {
-			ibrs_state = 1;
-			ibpb_state = 1;
+	if (cpuid_edx(7) & BIT(26)) {
+		ibrs_state = 1;
+		ibpb_state = 1;
 
-			setup_force_cpu_cap(X86_FEATURE_SPEC_CTRL);
-			setup_force_cpu_cap(X86_FEATURE_MSR_SPEC_CTRL);
-		}
-	} else if (boot_cpu_data.x86_vendor == X86_VENDOR_AMD) {
-		if (boot_cpu_has(X86_FEATURE_SPEC_CTRL))
-			ibrs_state = 1;
+		setup_force_cpu_cap(X86_FEATURE_SPEC_CTRL);
+		setup_force_cpu_cap(X86_FEATURE_MSR_SPEC_CTRL);
+	}
 
-		if (boot_cpu_has(X86_FEATURE_AMD_IBPB)) {
+	if (boot_cpu_data.x86_vendor == X86_VENDOR_AMD) {
+		if (cpuid_ebx(0x80000008) & BIT(12)) {
 			ibpb_state = 1;
+		} else {
+			ibpb_state = 0;
 		}
 	}
 }
