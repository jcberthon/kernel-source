From: Thomas Gleixner <tglx@linutronix.de>
Date: Fri, 11 May 2018 15:21:01 +0200
Subject: KVM: SVM: Move spec control call after restore of GS
Patch-mainline: v4.17-rc6
Git-commit: 15e6c22fd8e5a42c5ed6d487b7c9fe44c2517765
References: bsc#1087082 CVE-2018-3639

svm_vcpu_run() invokes x86_spec_ctrl_restore_host() after VMEXIT, but
before the host GS is restored. x86_spec_ctrl_restore_host() uses 'current'
to determine the host SSBD state of the thread. 'current' is GS based, but
host GS is not yet restored and the access causes a triple fault.

Move the call after the host GS restore.

Fixes: 5cf687548705 ("x86/bugs, KVM: Support the combination of guest and host IBRS")
Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
Signed-off-by: Borislav Petkov <bp@suse.de>
---
 arch/x86/kvm/svm.c |    4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

--- a/arch/x86/kvm/svm.c
+++ b/arch/x86/kvm/svm.c
@@ -4952,8 +4952,6 @@ static void svm_vcpu_run(struct kvm_vcpu
 #endif
 		);
 
-	x86_spec_ctrl_restore_host(svm->spec_ctrl);
-
 	/* Eliminate branch target predictions from guest mode */
 	vmexit_fill_RSB();
 
@@ -4966,6 +4964,8 @@ static void svm_vcpu_run(struct kvm_vcpu
 	if (boot_cpu_has(X86_FEATURE_MSR_SPEC_CTRL))
 		svm->spec_ctrl = native_read_msr(MSR_IA32_SPEC_CTRL);
 
+	x86_spec_ctrl_restore_host(svm->spec_ctrl);
+
 	reload_tss(vcpu);
 
 	local_irq_disable();
