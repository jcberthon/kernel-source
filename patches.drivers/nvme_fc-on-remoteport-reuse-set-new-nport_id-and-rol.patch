From: James Smart <jsmart2021@gmail.com>
Date: Mon, 5 Mar 2018 20:55:49 -0800
Subject: [PATCH] nvme_fc: on remoteport reuse, set new nport_id and role.
References: bsc#1076760
Patch-mainline: v4.17-rc1
Git-commit: 0cdd5fca876b1e9c56ca01186ba650b680248b35

When reattaching to a removed remoteport that has not yet been
fully deleted as it's waiting for reconnect timeouts, be sure to
re-set the ports nport id and role.

Signed-off-by: James Smart <james.smart@broadcom.com>
Acked-by: Hannes Reinecke <hare@suse.com>
---
 drivers/nvme/host/fc.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/drivers/nvme/host/fc.c b/drivers/nvme/host/fc.c
index 2ac55e6520f2..b9dd1ee67769 100644
--- a/drivers/nvme/host/fc.c
+++ b/drivers/nvme/host/fc.c
@@ -606,6 +606,8 @@ nvme_fc_attach_to_suspended_rport(struct nvme_fc_lport *lport,
 			return ERR_PTR(-ESTALE);
 		}
 
+		rport->remoteport.port_role = pinfo->port_role;
+		rport->remoteport.port_id = pinfo->port_id;
 		rport->remoteport.port_state = FC_OBJSTATE_ONLINE;
 		rport->dev_loss_end = 0;
 
-- 
2.12.3

