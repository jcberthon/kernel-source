From: Vasilis Liaskovitis <vliaskovitis@suse.com>
Date: Tue, 16 Oct 2018 18:05:58 +0200
Subject: [PATCH] xen/blkfront: avoid NULL blkfront_info dereference on device
 removal
Patch-mainline: 4.20-rc1
Git-commit: f92898e7f32e3533bfd95be174044bc349d416ca
References: bsc#1111062

If a block device is hot-added when we are out of grants,
gnttab_grant_foreign_access fails with -ENOSPC (log message "28
granting access to ring page") in this code path:

talk_to_blkback ->
    setup_blkring ->
	    xenbus_grant_ring ->
		    gnttab_grant_foreign_access

and the failing path in talk_to_blkback sets the driver_data to NULL:

destroy_blkring:
    blkif_free(info, 0);

    mutex_lock(&blkfront_mutex);
    free_info(info);
    mutex_unlock(&blkfront_mutex);

    dev_set_drvdata(&dev->dev, NULL);

This results in a NULL pointer BUG when blkfront_remove and blkif_free
try to access the failing device's NULL struct blkfront_info.

Signed-off-by: Vasilis Liaskovitis <vliaskovitis@suse.com>
Reviewed-by: Roger Pau Monn√© <roger.pau@citrix.com>
Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
Signed-off-by: Jens Axboe <axboe@kernel.dk>
---
 drivers/block/xen-blkfront.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/drivers/block/xen-blkfront.c b/drivers/block/xen-blkfront.c
index 5212831a1599..9c5cddcd113e 100644
--- a/drivers/block/xen-blkfront.c
+++ b/drivers/block/xen-blkfront.c
@@ -2186,6 +2186,9 @@ static int blkfront_remove(struct xenbus_device *xbdev)
 
 	dev_dbg(&xbdev->dev, "%s removed", xbdev->nodename);
 
+	if (!info)
+		return 0;
+
 	blkif_free(info, 0);
 
 	mutex_lock(&info->mutex);
-- 
2.19.1

